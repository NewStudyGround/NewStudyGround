name: ci

# push 될 때 마다 dev-back에서 Docker 이미지 빌드하고 push
on:
  push:
    branches:
      - "dev-back"


jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      
      #해당 이벤트에 연결된 커밋을 작업 공간으로 가지고 오는 작업
      -
        name: Checkout
        uses: actions/checkout@v4 

       # 자바 버전 11 설치되어있는지 확인
      - 
        name: Set up JDK 11
        uses: actions/setup-java@v3.13.0
        with:
          java-version: '11'

      # Gradle 실행 권한 부여 및 실행
      - 
        name: Grant execute permission for gradle
        run: chmod +x gradlew
      -
        name: Build with Gradle
        run: ./gradlew build

      #도커 로그인
      -
        name: Login to Docker Hub
        uses: docker/login-action@v3 
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} #도커 로그인 아이디
          password: ${{ secrets.DOCKERHUB_TOKEN }} #도커 로그인 비밀번호

      #도커 빌드
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      #도커파일, 코드, 파일을 기반으로 이미지 빌드하고 결과를 도커 레지스트리에 푸쉬
      -
        name: Build and push
        uses: docker/build-push-action@v5 
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/clockbox:latest  #생성된 도커 이미지에 태그 지정
